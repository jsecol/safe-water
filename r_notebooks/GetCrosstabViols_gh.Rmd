---
title: "CFB manage violations I"
author: "Jim Sheehan"
date: "March 18, 2019"
output: github_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, strip.white = FALSE)

```

<br>

## 0. Load packages
```{r message=FALSE}
library(data.table)
library(dplyr) # some masking of data.table: between, first, last
library(ggplot2)
library(zipcode) # for getting lat/lon coordinates where zipcode is available
library(lubridate)

```

<br>

## I. Load data

<br>

```{r results='hold'}

# library(readr)
# viol_all <- read_csv("VIOLATION.csv")
# read_csv too slow with big files like VIOLATION
# data.table fread() uses multiple cores
# can check first:  
# getDTthreads()

# the latest download
viol_all <- fread("C:/Users/Jim/Files/CFB/JohnMeroth/SDWIS/VIOLATION.csv", 
                  sep = ",")

orig_nrows <- nrow(viol_all)
orig_nrows
```

<br>

#### Small fix of column names (dropping string before "."), and dropping extra empty column:
```{r}
viol_all[, V35 := NULL]

varnames <- colnames(viol_all)
head(varnames)

varnames <- gsub("^.*\\.","",varnames)
colnames(viol_all) <- varnames
# fixed variable names
cat("\n")
varnames


```

<br>

#### (Fairly) quick test for duplicates: no unique row identifier column so whole thing:
```{r results='hold'}
dups_viol_all <- duplicated(viol_all)

dups_sum <- sum(dups_viol_all)
dups_sum

if(dups_sum == 0) {
  rm(dups_viol_all)
}

```

<br>

#### Looking for duplicates in primary (composite) key:
```{r}
viol_all %>% 
  count(PWSID, VIOLATION_ID) %>% 
  filter(n > 1)

```

<br>

#### OK, create a unique key:
```{r}
viol_all[, RowID := paste0(PWSID, VIOLATION_ID)]
setkey(viol_all, RowID)
key(viol_all)
```

<br>

#### Convert some columns to date format:
```{r results='hold'}
#### Testing to get format right
# tmpdate <- viol_all[1:10,]$COMPL_PER_BEGIN_DATE
# as.IDate(tmpdate, format = "%d-%b-%y")

viol_all[, cpbd := as.IDate(COMPL_PER_BEGIN_DATE, format = "%d-%b-%y")]
viol_all[, cped := as.IDate(COMPL_PER_END_DATE, format = "%d-%b-%y")]
viol_all[, rtcd := as.IDate(RTC_DATE, format = "%d-%b-%y")]

class(viol_all$cpbd)
summary(viol_all$cpbd)
```

*Note: max compliance period begin date way beyond present! Just a couple: PR0004565, LA1017050*

<br>

#### Add some new columns to help create yearly timeline (later):
```{r results='hold'}
viol_all[, cpbd_year := year(cpbd)]
viol_all[, cped_year := year(cped)]

viol_all[, ydiff := cped_year - cpbd_year]

cat("Difference in years: compliance end date - begin date (some oddities)", "\n\n")
summary(viol_all$ydiff)

```

<br>

#### #*COMPLIANCE_STATUS_CODE is important for understanding violation timeline*

```{r}
unique(viol_all$COMPLIANCE_STATUS_CODE)

```

<br>

by PWS_ACTIVITY_CODE  

+ Active, Inactive, M (missing?), N (what is this?)

```{r}
table(viol_all$COMPLIANCE_STATUS_CODE, viol_all$PWS_ACTIVITY_CODE)
```

<br>

#### #*COMPLIANCE_STATUS_CODE I's have no active water systems, just need R, O, and K*

<br>

#### Filtering out COMPLIANCE_STATUS_CODE = "R" (returned to compliance), PWS_ACTIVITY_CODE = "Active", rtcd (returned to compliance date) within period of interest, and tallying by IS_HEALTH_BASED_IND

+ *compliance period begin date could also be filtered for same period, as for O and K below, but just using RTC date = a lot more PWSIDs kept. Looking at tmp, it seems compliance period begin/end dates not necessarily tied to RTC date*

<br>

+ RTC_y08y16_nHB = "returned to compliance within 2008-2016 period, non-health based violation"
+ RTC_y08y16_HB = "returned to compliance within 2008-2016 period, health based violation"


```{r}
# , between(cpbd, as.Date("2008-01-01"), as.Date("2016-12-31")) # taken out of filter

viol_RTC <- viol_all %>% filter(COMPLIANCE_STATUS_CODE == "R", PWS_ACTIVITY_CODE == "A",
                    between(rtcd, as.Date("2008-01-01"), as.Date("2016-12-31"))) %>% 
  group_by(PWSID, PWS_TYPE_CODE, PWS_ACTIVITY_CODE, IS_HEALTH_BASED_IND) %>% 
  count(name = "RTC_0816_n") %>% 
  tidyr::spread(key = IS_HEALTH_BASED_IND, value = RTC_0816_n, fill = 0) %>% 
  rename(RTC_y08y16_nHB = N, RTC_y08y16_HB = Y)

nrow(viol_RTC)
head(viol_RTC)

```

<br>

```{r}
# explore of cpbd before/after period for these
tmp <- viol_all %>% filter(COMPLIANCE_STATUS_CODE == "R", PWS_ACTIVITY_CODE == "A",
                    between(rtcd, as.Date("2008-01-01"), as.Date("2016-12-31")),
                    cpbd < as.Date("2008-01-01") | cpbd > as.Date("2016-12-31"))

length(unique(tmp$PWSID))

tmp %>% select(cpbd:rtcd, PWSID:VIOLATION_ID, 
               PWS_TYPE_CODE:CONTAMINANT_CODE) %>% 
  arrange(cpbd) %>% head(n = 10)

tmp %>% select(cpbd:rtcd, PWSID:VIOLATION_ID, 
               PWS_TYPE_CODE:CONTAMINANT_CODE) %>% 
  arrange(cpbd) %>% tail(n = 10)
```


<br>

#### Filtering out COMPLIANCE_STATUS_CODE = "O" (open violation), PWS_ACTIVITY_CODE = "Active", cpbd (compliance period begin date; these have no end date or rtc date) within period of interest, and tallying by IS_HEALTH_BASED_IND

+ O_y08y16_nHB = "Open violation within 2008-2016 period, non-health based violation"
+ O_y08y16_nHB = "Open violation within 2008-2016 period, health based violation"


```{r}
viol_O <- viol_all %>% filter(COMPLIANCE_STATUS_CODE == "O", PWS_ACTIVITY_CODE == "A",
                    between(cpbd, as.Date("2008-01-01"), as.Date("2016-12-31"))) %>% 
  group_by(PWSID, PWS_TYPE_CODE, PWS_ACTIVITY_CODE, IS_HEALTH_BASED_IND) %>% 
  count(name = "O_0816_n") %>% 
  tidyr::spread(key = IS_HEALTH_BASED_IND, value = O_0816_n, fill = 0) %>% 
  rename(O_y08y16_nHB = N, O_y08y16_HB = Y)

nrow(viol_O)
head(viol_O)

```


<br>

#### Filtering out COMPLIANCE_STATUS_CODE = "K" (known: not really sure what this is yet), PWS_ACTIVITY_CODE = "Active", cpbd (compliance period begin date; these have end dates - some later than period, but not sure how/if to use, and no rtc date) within period of interest, and tallying by IS_HEALTH_BASED_IND

+ K_y08y16_nHB = "Known within 2008-2016 period, non-health based violation"
+ K_y08y16_nHB = "Known within 2008-2016 period, health based violation"


```{r results='hold'}
viol_K <- viol_all %>% filter(COMPLIANCE_STATUS_CODE == "K", PWS_ACTIVITY_CODE == "A",
                    between(cpbd, as.Date("2008-01-01"), as.Date("2016-12-31"))) %>% 
  group_by(PWSID, PWS_TYPE_CODE, PWS_ACTIVITY_CODE, IS_HEALTH_BASED_IND) %>% 
  count(name = "K_0816_n") %>% 
  tidyr::spread(key = IS_HEALTH_BASED_IND, value = K_0816_n, fill = 0) %>% 
  rename(K_y08y16_nHB = N, K_y08y16_HB = Y)

head(viol_K)

# weird, just 1: 
sum(viol_K$V1)
# it's VI3000052, blank for IS_HEALTH_BASED_IND, dropping

viol_K <- viol_K %>% select(-V1)

nrow(viol_K)
head(viol_K)

```

<br>

#### Load new water system .csv:
```{r}
water_systems <- fread("C:/Users/Jim/Files/CFB/JohnMeroth/SDWIS/WATER_SYSTEM.csv", 
                  sep = ",")
```

<br>

#### Small fix of column names (dropping string before "."), and dropping extra empty column:
```{r}
water_systems[, V48 := NULL]

varnames_ws <- colnames(water_systems)
head(varnames_ws)

varnames_ws <- gsub("^.*\\.","",varnames_ws)
colnames(water_systems) <- varnames_ws
# fixed variable names
cat("\n")
varnames_ws


```

<br>

#### Looking for duplicates in primary key:
```{r}
water_systems %>% 
  count(PWSID) %>% 
  filter(n > 1)

```

<br>

#### Set primary key:
```{r}
setkey(water_systems, PWSID)
key(water_systems)
```

<br>

#### Join preliminaries:
```{r results='hold'}
setDT(viol_RTC)
length(unique(viol_RTC$PWSID)) == nrow(viol_RTC)
setkey(viol_RTC, PWSID)
key(viol_RTC)

setDT(viol_O)
length(unique(viol_O$PWSID)) == nrow(viol_O)
setkey(viol_O, PWSID)
key(viol_O)

setDT(viol_K)
length(unique(viol_K$PWSID)) == nrow(viol_K)
setkey(viol_K, PWSID)
key(viol_K)

```

<br>

#### Joining and filling in NA with 0:
```{r}
water_systems_A <- water_systems[PWS_ACTIVITY_CODE == "A"]
  
merge1 <- merge(water_systems_A, 
                viol_RTC[, c("PWSID", "RTC_y08y16_HB", "RTC_y08y16_nHB")], all.x = TRUE)

merge1 <- merge(merge1, 
                viol_O[, c("PWSID", "O_y08y16_HB", "O_y08y16_nHB")], all.x = TRUE)

merge1 <- merge(merge1, 
                viol_K[, c("PWSID", "K_y08y16_HB", "K_y08y16_nHB")], all.x = TRUE)

merge1[, c("RTC_y08y16_HB", "RTC_y08y16_nHB", 
           "O_y08y16_HB", "O_y08y16_nHB", 
           "K_y08y16_HB", "K_y08y16_nHB")] <- 
  lapply(merge1[, c("RTC_y08y16_HB", "RTC_y08y16_nHB", 
           "O_y08y16_HB", "O_y08y16_nHB", 
           "K_y08y16_HB", "K_y08y16_nHB")], function(x) ifelse(is.na(x), 0, x))

```

<br>

#### For export:
```{r}
merge1 %>% select(PWSID, RTC_y08y16_HB:K_y08y16_nHB) %>% 
  write.csv("data_export/ComplianceActivity_y08y16.csv", row.names = FALSE)

```

<br>

#### some stats, graphs:

+ some high numbers: e.g., WA5340950 has max #  RTC_y08y16_nHB @ 2,376! (verified as same count of rows in violations.csv)

```{r fig.height=8, fig.width=8}
merge1 %>% select(PWSID, RTC_y08y16_HB:K_y08y16_nHB) %>% summary()

merge1 %>% select(PWSID, RTC_y08y16_HB:K_y08y16_nHB) %>%
  tidyr::gather(Variable, Value, RTC_y08y16_HB:K_y08y16_nHB) %>% 
  filter(Value > 0) %>% 
  ggplot(aes(Value)) + geom_histogram(binwidth = 2, color = "orange") + 
  facet_wrap(~Variable, scales = "free", ncol = 2) + 
  coord_cartesian(xlim = c(0, 100))
```

<br>

#### Create binary version:
```{r}
merge1_binary <- merge1 %>% 
  mutate_at(vars(RTC_y08y16_HB:K_y08y16_nHB), function(x) ifelse(x > 0, 1, 0))

```

<br>

#### Summary of the number of water systems out of total for a state (plus DC & PR) that had a health based violation and returned to compliance over the 2008-2016 period:
```{r}
merge1_binary %>% filter(PWS_TYPE_CODE == "CWS", STATE_CODE %in% c(state.abb, "DC", "PR")) %>% 
  count(STATE_CODE, RTC_y08y16_HB) %>% 
  group_by(STATE_CODE) %>% 
  tidyr::spread(key = RTC_y08y16_HB, value = n, sep = "_") %>% 
  mutate(Total = RTC_y08y16_HB_0 + RTC_y08y16_HB_1, 
         Prop_RTC_y08y16_HB_1 = round(RTC_y08y16_HB_1/Total, 2)) %>% 
  arrange(desc(Prop_RTC_y08y16_HB_1))

```


<br>

#### Some exploratory analysis on potential predictors:
```{r results='hold'}

logmod1 <- merge1_binary %>% filter(STATE_CODE %in% c(state.abb, "DC", "PR")) %>% 
  mutate(PWS_TYPE_CODE = factor(PWS_TYPE_CODE)) %>% 
  glm(RTC_y08y16_HB ~ PWS_TYPE_CODE, 
               family = binomial(link = "logit"),
               data = .)

summary(logmod1)

cat("odds ratios, baseline is CWS:", "\n\n")
exp(coef(logmod1))

plot(effects::allEffects(logmod1))

```


#### Exploring time series (compliance period begin date: monthly)

```{r fig.width=8, fig.height=6}

viol_all_A_by_Month <- viol_all %>% filter(PWS_ACTIVITY_CODE == "A") %>% 
  mutate(cpbd_mo = ymd(paste(cpbd_year, month(cpbd), "1", sep = "-"))) %>%
  group_by(PWS_TYPE_CODE, cpbd_mo) %>% 
  summarise(cpbd_count = n())  


viol_all_A_by_Month %>% 
  ggplot(aes(x = cpbd_mo, y = cpbd_count, color = PWS_TYPE_CODE)) + 
  geom_line() + 
  scale_y_log10() +
  theme(legend.position = "bottom")
  
  
viol_all_A_by_Month %>% 
  filter(between(cpbd_mo, as.Date("2008-01-01"), as.Date("2017-12-31"))) %>% 
  ggplot(aes(x = cpbd_mo, y = cpbd_count, color = PWS_TYPE_CODE)) + 
  geom_line() + 
  scale_y_log10() + geom_smooth() +
  theme(legend.position = "bottom")

```

```{r fig.width=10, fig.height=6}
viol_all_A_Hb_by_Month <- viol_all %>% filter(PWS_ACTIVITY_CODE == "A", IS_HEALTH_BASED_IND == "Y") %>% 
  mutate(cpbd_mo = ymd(paste(cpbd_year, month(cpbd), "1", sep = "-"))) %>%
  group_by(PWS_TYPE_CODE, cpbd_mo) %>% 
  summarise(cpbd_count = n())


viol_all_A_Hb_by_Month %>% 
  filter(between(cpbd_mo, as.Date("2008-01-01"), as.Date("2018-12-31"))) %>% 
  ggplot(aes(x = cpbd_mo, y = cpbd_count, color = PWS_TYPE_CODE)) + 
  geom_line() + 
  scale_y_log10() + geom_smooth() +
  theme(legend.position = "bottom")
```



```{r fig.width=9, fig.height=6}

viol_all_A_Hb_by_Month %>% 
  filter(between(cpbd_mo, as.Date("2017-01-01"), as.Date("2018-12-31"))) %>% 
  ggplot(aes(x = cpbd_mo, y = cpbd_count, color = PWS_TYPE_CODE)) + 
  geom_line() + geom_point() +
  scale_x_date(breaks = c(as.Date("2016-12-01"), as.Date("2017-03-01"), 
                          as.Date("2017-06-01"), as.Date("2017-09-01"),
                          as.Date("2017-12-01"), as.Date("2018-03-01"), 
                          as.Date("2018-06-01"), as.Date("2018-09-01"),
                          as.Date("2018-12-01")), 
               date_minor_breaks = "month",
               date_labels = "%Y-%m") +
  xlab("Compliance period begin date month") +
  ylab("Count of health-based violations") + 
  ggtitle("2017-Present count of health-based violations by month in SDWIS", 
          subtitle = "data: compliance period begin dates from most recent Violations.csv download") +
  theme(legend.position = "bottom", 
        panel.background = element_rect(fill = NA),
        panel.border = element_rect(fill = NA, color = "black"),
        axis.text.x = element_text(angle = 45, vjust = 1.0, hjust = 1.0), 
        axis.ticks = element_line(size = 2))



```





<br><br><br><br>


