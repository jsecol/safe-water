---
title: "Coord_MakeShapefiles"
author: "Jim Sheehan"
date: "April 29, 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>

## 0. Load packages
```{r message=FALSE}
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(sp)
library(sf)
library(rnaturalearth)

```

<br>

## I. Load data
```{r}

PWSID_coordinates <- read_csv("data_export/PWSID_coordinates.csv.gz")
PWSID_violation_x <- read_csv("data_export/viol_HB_byYear0817_x.csv.gz")
EWG_large_PWSID <- read_csv("data_export/EWG_large_PWSID.csv.gz")
US_cities <- read_csv("C:/Users/Jim/Files/CFB/data/uscitiesv1_5.csv")

```

<br>

## II. Create spatial object

<br>

+ convert violations to presence/absence, shorten names to meet ESRI specs
```{r}

PWSID_violation_x[, 3:22] <- lapply(PWSID_violation_x[, 3:22], function(x) ifelse(x > 0, 1, 0))

PWSID_violation_x <- PWSID_violation_x %>% 
  rename_at(vars(starts_with("CPBD_")), 
            list(~str_replace(., "CPBD_", "")))

```

<br>

+ join data 
```{r}

shape1_dat <-
  left_join(PWSID_coordinates, PWSID_violation_x[,-2], by = "PWSID")

# replace NA with 0 for PWSIDs with no violations
shape1_dat[23:42] <-
  lapply(shape1_dat[23:42], function(x)
    ifelse(is.na(x), 0, x))

#### Maybe don't do this now, do for separate EWG (do in own notebook!!)

shape1_dat <- left_join(shape1_dat, EWG_large_PWSID, by = "PWSID")

# some unmatched by zip code
sum(is.na(shape1_dat$LAT))

shape1_dat <- shape1_dat %>%
  filter(!is.na(shape1_dat$LAT))

# still a few with different State than PRIMACY_AGENCY_CODE State
shape1_dat %>% filter(!is.na(EWG_Name),
                      PRIMACY_AGENCY_CODE != Rzcpkg_state) %>%
  select(PWSID, EWG_Name, EWG_City, PRIMACY_AGENCY_CODE, Rzcpkg_state)

```

<br>

+ make sp point object
```{r}
geo_prj <- "+proj=longlat +ellps=WGS84"

shape1_sp <-
  SpatialPointsDataFrame(coords = shape1_dat[, c("LON", "LAT")],
                         data = shape1_dat,
                         proj4string = CRS(geo_prj))

# plot it (just CWS)
sp::plot(shape1_sp["PWS_TYPE_CODE" == "CWS"])

```

<br>

+ make one just for large EWG PWSIDs (trying to geocode to city instead of using zip code)
```{r}
shape2_dat <- shape1_dat %>%
  filter(!is.na(shape1_dat$EWG_Name))

city_match1 <-
  shape2_dat %>% group_by(PRIMACY_AGENCY_CODE, EWG_City) %>%
  count(name = "n_match") %>%
  inner_join(.,
             US_cities,
             by = c("PRIMACY_AGENCY_CODE" = "state_id",
                    "EWG_City" = "city")) %>%
  select(PRIMACY_AGENCY_CODE, EWG_City, id) %>%
  rename(UScities_id = id) %>% 
  mutate(UScities_match = "Auto")

head(city_match1)
```

+ just ID for now, and implement fuzzy/manual matching
```{r}
shape2_dat_tmp <- shape2_dat %>% 
  left_join(., city_match1, 
            by = c("PRIMACY_AGENCY_CODE" = "PRIMACY_AGENCY_CODE", 
                   "EWG_City" = "EWG_City"))


state_city_unm <- shape2_dat_tmp %>% 
  filter(is.na(UScities_id)) %>%
  select(PRIMACY_AGENCY_CODE, EWG_City)

```


http://bigdata-doctor.com/fuzzy-string-matching-survival-skill-tackle-unstructured-information-r/


```{r}
list_matches <- list()
for (i in 1:nrow(state_city_unm)) {
  state_city <- state_city_unm[i,]
  state <- state_city$PRIMACY_AGENCY_CODE
  US_cities_sub <- US_cities[US_cities$state_id == state,]
  # not being overly strict here, with max.distance > 0:
  index <- agrep(
    state_city$EWG_City,
    US_cities_sub$city_ascii,
    max.distance = 0.1,
    ignore.case = TRUE
  )
  US_cities_sub$EWG_City <- state_city$EWG_City
  US_cities_sub$PRIMACY_AGENCY_CODE <- state_city$PRIMACY_AGENCY_CODE
  US_cities_match <- US_cities_sub[index,]
  
  #### need loop
  vals_collect <- NULL
  if (nrow(US_cities_match) > 0) {
  for (j in 1:nrow(US_cities_match)) {
    vals <- t(drop(attr(
      adist(
        US_cities_match[j,]$EWG_City,
        US_cities_match[j,]$city_ascii,
        counts = TRUE,
        ignore.case = TRUE
      ),
      "counts"
    )))
    vals_collect <- rbind(vals_collect, vals)
  }
    US_cities_match <- cbind(US_cities_match, vals_collect)
  }

  list_matches[[i]] <- US_cities_match
}

list_matches_df <- do.call(rbind, list_matches)

list_matches_df <- list_matches_df %>% filter(!is.na(city))

list_matches_df <- list_matches_df %>% distinct()

list_matches_df

# for manual check
list_matches_df %>% write.csv("data_export/list_matches_df.csv", row.names = FALSE)


```

#### Post manual matching
```{r}
library(readxl)

list_matches_df_selections <- read_excel("data_export/list_matches_df_selections.xlsx")


```







<br>

+ make sp point object
```{r}

shape2_sp <- SpatialPointsDataFrame(coords = shape2_dat[,c("LON", "LAT")], 
                           data = shape2_dat, proj4string = CRS(geo_prj))

# plot it
sp::plot(shape2_sp)

```

<br>

+ save ESRI shapefiles using rgdal (here to local directory, can get big)

```{r}
shape_dir <- "C:/temp/CFB/shapes"

rgdal::writeOGR(obj = shape1_sp, dsn = shape_dir, layer = "Active_PWSID_Viol2008_17", driver="ESRI Shapefile", overwrite_layer = TRUE)

rgdal::writeOGR(obj = shape2_sp, dsn = shape_dir, layer = "EWG_large_PWSID", driver="ESRI Shapefile", overwrite_layer = TRUE)

```

<br>

## III. Combined mainland + AK & HI map example

<br>

+ showing 2016 HB violations for just zip codes with EWG PWSIDs
+ coding mostly thanks to: https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-3.html

```{r}
# # ne_countries() use scale = "large" if want most detail, 
# # requires additional rnaturalearthhires package

# country_usa <- ne_countries(scale = "medium", 
#                             country = "United States of America", 
#                             returnclass = "sf")

# this used instead for now (could use country to supply North America)
states_usa <- ne_states(country = "United States of America", 
                            returnclass = "sf")
st_crs(states_usa)

shape2_sp_mainland <- subset(shape2_sp, !PRIMACY_AGENCY_CODE %in% c("AK", "HI"))

mainland_xy <- st_as_sf(shape2_sp_mainland)
st_crs(mainland_xy)

mainland_xy_hb2016_y <- subset(mainland_xy, HB_Y_2016 == 1)

shape2_sp_AK <- subset(shape2_sp, PRIMACY_AGENCY_CODE == "AK")
alaska_xy <- st_as_sf(shape2_sp_AK)
alaska_xy_hb2016_y <- subset(alaska_xy, HB_Y_2016 == 1)

shape2_sp_HI <- subset(shape2_sp, PRIMACY_AGENCY_CODE == "HI")
hawaii_xy <- st_as_sf(shape2_sp_HI)
hawaii_xy_hb2016_y <- subset(hawaii_xy, HB_Y_2016 == 1) # NONE

```

<br>

```{r}

mainland_hb2016_y <- ggplot(data = states_usa) + 
  geom_sf(fill = "cornsilk") + 
  geom_sf(data = mainland_xy, color = "gray60", size = 1) + 
  geom_sf(data = mainland_xy_hb2016_y, color = "red") + 
  theme(panel.grid.major = element_line(color = "white"), 
        panel.background = element_rect(fill = "aliceblue", color = "black")) +
  coord_sf(crs = st_crs(2163), 
           xlim = c(-2500000, 2500000), 
           ylim = c(-2300000, 730000)) + 
  ggtitle("Zip codes for EWG PWSIDs (n = 4,206)", 
          subtitle = "red had a health-based violation in 2016 (n = 248)")

# mainland_hb2016_y
```

<br>

```{r}
alaska_hb2016_y <- ggplot(data = states_usa) + 
  geom_sf(fill = "cornsilk") + 
  geom_sf(data = alaska_xy, color = "gray60", size = 1) + 
  geom_sf(data = alaska_xy_hb2016_y, color = "red") + 
  theme(panel.background = element_rect(fill = "aliceblue", color = "black")) +
  coord_sf(crs = st_crs(3467), 
           xlim = c(-2400000, 1600000), 
           ylim = c(200000, 2500000), 
           expand = FALSE, datum = NA)

# alaska_hb2016_y
```

<br>

```{r}
hawaii_hb2016_y <- ggplot(data = states_usa) + 
  geom_sf(fill = "cornsilk") + 
  geom_sf(data = hawaii_xy, color = "gray60", size = 1) + 
#  geom_sf(data = hawaii_xy_hb2017_y, color = "red") + 
  theme(panel.background = element_rect(fill = "aliceblue", color = "black")) +
  coord_sf(crs = st_crs(4135), 
           xlim = c(-161, -154), 
           ylim = c(18, 23), 
           expand = FALSE, datum = NA)

# hawaii_hb2016_y
```

<br>

```{r fig.width=8}
mainland_hb2016_y +
 annotation_custom(
      grob = ggplotGrob(alaska_hb2016_y),
      xmin = -2750000,
      xmax = -2750000 + (1600000 - (-2400000))/2.5,
      ymin = -2450000,
      ymax = -2450000 + (2500000 - 200000)/2.5
  ) +
  annotation_custom(
      grob = ggplotGrob(hawaii_hb2016_y),
      xmin = -1250000,
      xmax = -1250000 + (-154 - (-161))*120000,
      ymin = -2450000,
      ymax = -2450000 + (23 - 18)*120000
  )
```


+ Also see:
https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html




