---
title: "Map region 01 (New England) boundaries"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
    toc_depth: 3
---

### Description

Brief description.

Data sources:

1. https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html
2. https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2018&layergroup=County+Subdivisions *(preferred)*
3. SELECTED ECONOMIC CHARACTERISTICS 2013-2017 American Community Survey 5-Year Estimates: 2017 latest year available at 

Coding outline:

1. 
2. 
3. 
4. 



### Load packages

```{r message=FALSE}

# # this package can work with googledrive to get a specific worksheet in a google sheet
# # (currently in development, not on CRAN)
# devtools::install_github("tidyverse/googlesheets4")

library(dplyr)
library(sf)
library(fs)
library(googledrive)
library(googlesheets4)
library(readr)

```


### Unzip data (if needed)

+ if already have, can change `overwrite = FALSE`

```{r warning=FALSE}

zipdir1 <- dir_ls("C:/temp/CFB/vector/zipped", glob = "*.zip")

for(i in 1:length(zipdir1)) {
unzip(zipdir1[i],
      exdir = "C:/temp/CFB/vector/unzipped",
      junkpaths = TRUE,
      overwrite = FALSE)
}

# unzipped shapefile dir
shpdir <- dir_ls("C:/temp/CFB/vector/unzipped", glob = "*.shp") 

shpdir %>% 
  basename()

```

### Load shapefiles

```{r}

shp_list <- list()

for(i in 1:length(shpdir)) {
  shp <- st_read(shpdir[i], stringsAsFactors = FALSE, quiet = TRUE)
  shp <- st_transform(shp, crs = 26918)
  shp_list[[i]] <- shp
}

names(shp_list) <- basename(shpdir)

names(shp_list)

state_byfips <- c("CT", "ME", "MA", "NH", "RI", "VT")

names(shp_list) <- state_byfips

names(shp_list)

```

### Load points 
*(from water shared drive, need to login/authenticate in web browser when run)*

```{r}

# # another way, but also can explore what's in the drive (includes any shared files)
# gdfiles <- drive_find(pattern = "Water", type = "spreadsheet")
# gdfiles$name
# gdfiles$id

locations_dat <- drive_get("WaterSystem_Locations") %>% 
  read_sheet(sheet = "Region01")

```


```{r}

st_crs(shp_list[[1]])

locations_pts <- st_as_sf(locations_dat, coords = c("LON", "LAT"), crs = 4163) %>% 
  st_transform(crs = st_crs(shp_list[[1]]))

```


### Combine them (or join points in them state by state first? probably better)

see: 
https://ryanpeek.github.io/mapping-in-R-workshop/vig_spatial_joins.html

```{r}

# # do in a loop to list instead

# locations_pts_VT <- 
#   st_join(locations_pts[locations_pts$PRIMACY_AGENCY_CODE == "VT",], 
#           left = TRUE, shp_list[[6]])
# 
# sum(is.na(locations_pts_VT$INTPTLAT))

# # Note: this skips PRIMACY_AGENCY_CODE "01", only 1 so get others with this one separately

joined_list <- list()

for(i in 1:length(state_byfips)) {
  joined <- locations_pts %>% 
    filter(PRIMACY_AGENCY_CODE == state_byfips[i]) %>% 
    st_join(., left = TRUE, shp_list[[state_byfips[i]]]) %>% 
    st_drop_geometry()
  joined_list[[i]] <- joined
  
}

names(joined_list) <- state_byfips

joined_df <- do.call(bind_rows, joined_list)

# check if any not matched
sum(is.na(joined_df$INTPTLAT))

joined_df %>% filter(is.na(joined_df$INTPTLAT))

locations_dat %>% filter(PWSID == "MA2115001")

# 42.70396, -71.60161 appears to be bad, over border in NH

```



### Export

```{r}

# put in github data folder eventually?

dir_create("C:/temp/CFB/data/processed")

joined_df %>% write_csv("C:/temp/CFB/data/processed/r01_pwsid_cosub.csv")

```



### Join to census data

```{r}


zipdir2 <- dir_ls("C:/temp/CFB/table/zipped", glob = "*.zip")

for(i in 1:length(zipdir2)) {
unzip(zipdir2[i],
      exdir = paste0("C:/temp/CFB/table/unzipped", "/", "folder", i),
      junkpaths = TRUE,
      overwrite = FALSE)
}


census_files <- dir_ls("C:/temp/CFB/table/unzipped", 
                       recurse = TRUE, 
                       glob = "*ACS_17_5YR_DP03.csv")

census_list <- list()
for(i in 1:length(census_files)){
  dat <- read_csv(census_files[i], col_types = cols(.default = "c"))
  census_list[[i]] <- dat
}

census_dat <- do.call(bind_rows, census_list)

# lots of columns, trim down and convert to numeric where necessary



```






### Map them


```{r}
# just one, for example

plot(shp_list[[6]]$geometry)

plot(locations_pts[locations_pts$PRIMACY_AGENCY_CODE == "VT",]["PRIMACY_AGENCY_CODE"], 
     add = TRUE, col = "red")

```









