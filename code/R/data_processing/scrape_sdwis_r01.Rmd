---
title: "scrape_sdwis_r01"
author: "Jim Sheehan"
date: "10/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


https://heads0rtai1s.github.io/2019/10/03/reticulate-intro/


```{r message=FALSE}

library(readr)
library(xml2)
library(lubridate)
library(dplyr)

```


#### too many viols, need to loop

+ loop by state, well under 100000 max
+ warning is for extra empty column, ignore

```{r warning=FALSE}

datetime <- gsub(" ", "_", Sys.time())
datetime <- gsub(":", "-", datetime)


url_epa01_wsys <-
  "https://data.epa.gov/efservice/WATER_SYSTEM/EPA_REGION/01/PWS_ACTIVITY_CODE/A/CSV"

water_system_fresh <- read_csv(url_epa01_wsys, col_types = cols(.default = "c"))


pac_vals <- sort(unique(water_system_fresh$WATER_SYSTEM.PRIMACY_AGENCY_CODE))

url_base_viol <- "https://data.epa.gov/efservice/VIOLATION/PWS_ACTIVITY_CODE/A/PRIMACY_AGENCY_CODE/"

violation_fresh <- list()

for (i in 1:length(pac_vals)) {
  viols <- read_csv(paste0(url_base_viol, pac_vals[i], "/CSV"),
                    col_types = cols(.default = "c"))
  violation_fresh[[i]] <- viols
  
}


violation_fresh <- do.call(bind_rows, violation_fresh)


violation_fresh %>% 
  group_by(VIOLATION.PRIMACY_AGENCY_CODE) %>% 
  tally()


violation_fresh %>% 
  write_csv(paste0("C:/Users/Jim/OneDrive/CFB/R_exports/SDWIS_tracking/violation_", 
                   datetime, ".csv"))
water_system_fresh %>% 
  write_csv(paste0("C:/Users/Jim/OneDrive/CFB/R_exports/SDWIS_tracking/water_system_", datetime, ".csv"))


```




*try public notification tier*

*try scheduler addin*




```{r}

violation_fresh <- violation_fresh %>% 
  mutate(VIOLATION.COMPL_PER_BEGIN_DATE = dmy(VIOLATION.COMPL_PER_BEGIN_DATE)) %>% 
  filter(TRUE)

summary(violation_fresh$VIOLATION.COMPL_PER_BEGIN_DATE)

```




#### MISC


*What is easiest way to get violation for PWSID and model it?*



```{r}

violations <- violation_fresh %>% 
  rename_all(~sub(".*\\.", "", .))

water_systems <- water_system_fresh %>% 
  rename_all(~sub(".*\\.", "", .))



violhistory <- violations %>%
  mutate(CPBD_YEAR = year(COMPL_PER_BEGIN_DATE)) %>% 
  group_by(PWSID, CPBD_YEAR, IS_HEALTH_BASED_IND) %>% 
  tally() %>% 
  tidyr::pivot_wider(names_from = IS_HEALTH_BASED_IND,
                     names_prefix = "HB_",
                     values_from = n,
                     values_fill = list(n = 0))

violhistory

```




```{r}

fulldata <- violhistory %>% 
  right_join(water_systems, ., by = "PWSID") %>% 
  select(PWSID, NPM_CANDIDATE, PRIMACY_AGENCY_CODE, 
                    PWS_TYPE_CODE, GW_SW_CODE, 
                    OWNER_TYPE_CODE:SERVICE_CONNECTIONS_COUNT, 
                    CPBD_YEAR:HB_Y) %>% 
  mutate_at(vars(HB_N, HB_Y), ~if_else(. > 0, 1, 0)) %>% 
  mutate(POPULATION_SERVED_COUNT = as.numeric(POPULATION_SERVED_COUNT))

fulldata

```

## (potential) feature engineering

```{r}

feat1 <- fulldata %>% 
  group_by(PWS_TYPE_CODE, PWSID) %>% 
  summarise(min_CPBD_YEAR = min(CPBD_YEAR),
            max_CPBD_YEAR = max(CPBD_YEAR),
            dif_CPBD_YEAR = max_CPBD_YEAR - min_CPBD_YEAR,
            sum_HB_N = sum(HB_N),
            sum_HB_Y = sum(HB_Y)) 

feat1 %>% 
  ggplot(aes(x = dif_CPBD_YEAR, y = sum_HB_Y, color = PWS_TYPE_CODE)) +
  geom_jitter(shape = 1) +
  geom_smooth(method = "lm")


feat1 %>% 
  ggplot(aes(x = dif_CPBD_YEAR, fill = PWS_TYPE_CODE)) +
  geom_histogram(binwidth = 1)


```



```{r}

YearMod <- 2016

traintestdat <- list()

PWS_TYPE_CODES <- unique(fulldata$PWS_TYPE_CODE)

for(i in 1:length(PWS_TYPE_CODES)) {
  index <- fulldata %>% 
  filter(CPBD_YEAR == YearMod, 
         PWS_TYPE_CODE == PWS_TYPE_CODES[i]) %>% 
  .$PRIMACY_AGENCY_CODE %>% 
  caret::createDataPartition(., times = 1, p = 0.33, list = FALSE)
  test <- fulldata %>% 
    filter(CPBD_YEAR == YearMod, 
         PWS_TYPE_CODE == PWS_TYPE_CODES[i]) %>% 
    slice(index) %>% 
    mutate(set = "test")
  train <- fulldata %>% 
    filter(CPBD_YEAR == YearMod, 
         PWS_TYPE_CODE == PWS_TYPE_CODES[i]) %>% 
    slice(-index) %>% 
    mutate(set = "train")
  traintestdat[[i]] <- bind_rows(train, test)
}

traintestdat <- do.call(bind_rows, traintestdat)

traintestdat %>% 
  mutate()

```

*if need be, can put 01 in train*

```{r}

traintestdat %>% 
  group_by(PWS_TYPE_CODE, set, PRIMACY_AGENCY_CODE) %>% 
  tally() %>% 
  tidyr::spread(set, n)

```


```{r}

round(prop.table(
  table(traintestdat[traintestdat$PWS_TYPE_CODE == "CWS", ]$PRIMACY_AGENCY_CODE,
        traintestdat[traintestdat$PWS_TYPE_CODE == "CWS", ]$set),
  margin = 2
), 3)

```


```{r}

feat1_toyear <- fulldata %>% 
  filter(CPBD_YEAR <= YearMod) %>% 
  group_by(PWS_TYPE_CODE, PWSID) %>% 
  summarise(min_CPBD_YEAR = min(CPBD_YEAR),
            max_CPBD_YEAR = max(CPBD_YEAR),
            dif_CPBD_YEAR = max_CPBD_YEAR - min_CPBD_YEAR,
            sum_HB_N = sum(HB_N),
            sum_HB_Y = sum(HB_Y)) 

```



```{r}

traintestdat <- feat1_toyear %>% ungroup() %>% 
  select(-PWS_TYPE_CODE) %>% 
  inner_join(traintestdat, ., by = "PWSID")

traintestdat

```


```{r}

predmodel <- traintestdat %>% 
  filter(PWS_TYPE_CODE == "CWS", set == "train") %>% 
  glm(dif_CPBD_YEAR ~ HB_Y, data = .)

summary(predmodel)

```



```{r}

pred <- traintestdat %>% 
  filter(PWS_TYPE_CODE == "CWS", set == "test") %>% 
  select(PWSID, HB_Y) %>% 
  predict(predmodel, newdata = ., type = "response", se.fit = TRUE) %>% 
  as.data.frame()


traintestdat %>% 
  filter(PWS_TYPE_CODE == "CWS", set == "test") %>% 
  bind_cols(., pred) %>% 
  ggplot(aes(x = factor(HB_Y), y = dif_CPBD_YEAR, group = HB_Y)) +
  geom_boxplot() +
  geom_errorbar(aes(x = factor(HB_Y), ymin = fit - se.fit, ymax = fit + se.fit), 
                color = "red") +
  geom_point(aes(x = factor(HB_Y), y = fit), color = "red")
  



```



**Just a test of partitioning, better to bootstrap diff in means by year using all data I believe**


```{r}

YearModBoot <- 2015


bootdat <- fulldata %>% 
  filter(CPBD_YEAR <= YearModBoot) %>% 
  group_by(PWSID) %>% 
  summarise(min_CPBD_YEAR = min(CPBD_YEAR),
            max_CPBD_YEAR = max(CPBD_YEAR),
            dif_CPBD_YEAR = max_CPBD_YEAR - min_CPBD_YEAR,
            sum_HB_N = sum(HB_N),
            sum_HB_Y = sum(HB_Y)) %>% 
  filter(max_CPBD_YEAR == YearModBoot) %>% 
  inner_join(., fulldata[fulldata$CPBD_YEAR == YearModBoot, ], by = "PWSID") %>% 
  select(dif_CPBD_YEAR, HB_Y) %>% 
  mutate(HB_Y = factor(HB_Y)) %>% 
  as.data.frame()




```




```{r}

library(boot)


meanDiff =function(x, w){
    y <- tapply(x[w,1], x[w,2], mean)
    y[1]-y[2]}


totalBoot = boot(bootdat, meanDiff, R = 10000, strata = bootdat[,2])

# Takes a while, need high R = 10000
totalBootCI = boot.ci(totalBoot)

totalBoot

totalBootCI
```



```{r}

bootdat %>% 
  group_by(HB_Y) %>% 
  summarise(meandif_CPBD_YEAR = mean(dif_CPBD_YEAR)) %>% 
  tidyr::spread(HB_Y, meandif_CPBD_YEAR) %>% 
  mutate(meandif = `0` - `1`)

```






*** 

OLD

```{r}

url1 <- "https://data.epa.gov/efservice/WATER_SYSTEM/PRIMACY_AGENCY_CODE/MA/CITY_NAME/ANDOVER/ROWS/0:10/CSV"

url2 <- "https://data.epa.gov/efservice/WATER_SYSTEM/PRIMACY_AGENCY_CODE/MA/CSV"

url3 <- "https://data.epa.gov/efservice/WATER_SYSTEM/PRIMACY_AGENCY_CODE/MA/CITY_NAME/BRAINTREE/VIOLATION/CSV"

url4 <- "https://data.epa.gov/efservice/VIOLATION/PRIMACY_AGENCY_CODE/MA/CSV"


url5 <- "https://data.epa.gov/efservice/VIOLATION/PRIMACY_AGENCY_CODE/MA/PWSID/MA4239049"

url6 <- "https://data.epa.gov/efservice/VIOLATION/PRIMACY_AGENCY_CODE/MA/PWSID/MA4239049/CSV"

url7 <- "https://data.epa.gov/efservice/LCR_SAMPLE/PRIMACY_AGENCY_CODE/MA/CSV"


url8 <- "https://data.epa.gov/efservice/VIOLATION/EPA_REGION/01/CONTAMINANT_CODE/BEGINNING/28/CSV"


# BEGINNING
# can't do?:
# "COMPL_PER_BEGIN_DATE/>"

```





```{r}

tmp_xml <- xml2::read_xml(url5)

# xml_child(tmp_xml, 1)

```



```{r}
url4
violations_fresh <- read_csv(url4, col_types = cols(.default = "c")) %>% 
  mutate(VIOLATION.COMPL_PER_BEGIN_DATE = dmy(VIOLATION.COMPL_PER_BEGIN_DATE)) %>% 
  filter(TRUE)
names(violations_fresh)
```


```{r}

summary(violations_fresh$VIOLATION.COMPL_PER_BEGIN_DATE)


```






```{r}
url7
lcr_sample_fresh <- read_csv(url7, col_types = cols(.default = "c")) %>% 
  mutate(VIOLATION.COMPL_PER_BEGIN_DATE = dmy(VIOLATION.COMPL_PER_BEGIN_DATE))

```



```{r}
url8 <- "https://data.epa.gov/efservice/VIOLATION/EPA_REGION/01/CONTAMINANT_CODE/BEGINNING/40/CSV"
violations_fresh_cont <- read_csv(url8, col_types = cols(.default = "c"))

```

#### too many viols!!, need to loop

```{r}

datetime <- gsub(" ", "_", Sys.time())
datetime <- gsub(":", "-", datetime)

url_epa01_viol <- "https://data.epa.gov/efservice/VIOLATION/EPA_REGION/01/CSV"
url_epa01_wsys <- "https://data.epa.gov/efservice/WATER_SYSTEM/EPA_REGION/01/CSV"

violation_fresh <- read_csv(url_epa01_viol, col_types = cols(.default = "c"))
water_system_fresh <- read_csv(url_epa01_wsys, col_types = cols(.default = "c"))


violations_fresh %>% write_csv(paste0("export/r01/violation_", datetime, ".csv"))
water_system_fresh %>% write_csv(paste0("export/r01/water_system_", datetime, ".csv"))


```






